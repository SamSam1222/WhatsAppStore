{% extends "IDGenie/base.html" %}
{% load static %}

{% block content %}

<style>
  /* Make iframes responsive */
  .responsive-iframe-wrapper {
      position: relative;
      padding-bottom: 56.25%;  /* 16:9 aspect ratio */
      height: 0;
      overflow: hidden;
      max-width: 100%;
      width: 100%;
      background: #000;
  }

  .responsive-iframe-wrapper iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
  }

  /* Make images responsive */
  .responsive-img-wrapper {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
  }

  .entry-content img {
      max-width: 100%;
      height: auto;
  }

  .profile-img {
    width: 50px;         /* Adjust the size as needed */
    height: 50px;        /* Keep it square to maintain the round shape */
    border-radius: 50%;  /* Makes the image round */
    object-fit: cover;   /* Ensures the image fits within the circle without stretching */
}

.comment-actions {
  margin-top: 10px;
  display: flex;
  gap: 15px;
  align-items: center;
}

.comment-actions span {
  cursor: pointer;
  color: #555;
  font-size: 14px;
}

.comment-actions span i {
  margin-right: 5px;
  font-size: 16px;
}

.comment-actions span:hover {
  color: #007BFF;
}

</style>

<div class="blog-page area-padding">
    <div class="container">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                <div class="page-head-blog">
                    <div class="single-blog-page">
                        <!-- Search option -->
                        <form action="#">
                            <div class="search-option">
                                <input type="text" placeholder="Search...">
                                <button class="button" type="submit">
                                    <i class="fa fa-search"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="single-blog-page">
                        <!-- Recent posts -->
                              <div class="left-blog">
                <h4>recent post</h4>
                <div class="recent-post">
                  <!-- start single post -->
                  <div class="recent-single-post">
                    <div class="post-img">
                      <a href="#">
												   <img src="{% static 'img/blog/1.jpg' %}" alt="">
												</a>
                    </div>
                    <div class="pst-content">
                      <p><a href="#"> Redug Lerse dolor sit amet consect adipis elit.</a></p>
                    </div>
                  </div>
                  <!-- End single post -->
                  <!-- start single post -->
                  <div class="recent-single-post">
                    <div class="post-img">
                      <a href="#">
												   <img src="{% static 'img/blog/2.jpg' %}" alt="">
												</a>
                    </div>
                    <div class="pst-content">
                      <p><a href="#"> Redug Lerse dolor sit amet consect adipis elit.</a></p>
                    </div>
                  </div>
                  <!-- End single post -->
                  <!-- start single post -->
                  <div class="recent-single-post">
                    <div class="post-img">
                      <a href="#">
												   <img src="{% static 'img/blog/3.jpg' %}" alt="">
												</a>
                    </div>
                    <div class="pst-content">
                      <p><a href="#"> Redug Lerse dolor sit amet consect adipis elit.</a></p>
                    </div>
                  </div>
                  <!-- End single post -->
                  <!-- start single post -->
                  <div class="recent-single-post">
                    <div class="post-img">
                      <a href="#">
												   <img src="{% static 'img/blog/4.jpg' %}" alt="">
												</a>
                    </div>
                    <div class="pst-content">
                      <p><a href="#"> Redug Lerse dolor sit amet consect adipis elit.</a></p>
                    </div>
                  </div>
                  <!-- End single post -->
                </div>
              </div>
              <!-- recent end -->
            </div>



            <div class="single-blog-page">
              <div class="left-blog">
                <h4>categories</h4>
                <ul>
                  <li>
                    <a href="#">Portfolio</a>
                  </li>
                  <li>
                    <a href="#">Project</a>
                  </li>
                  <li>
                    <a href="#">Design</a>
                  </li>
                  <li>
                    <a href="#">wordpress</a>
                  </li>
                  <li>
                    <a href="#">Joomla</a>
                  </li>
                  <li>
                    <a href="#">Html</a>
                  </li>
                  <li>
                    <a href="#">Website</a>
                  </li>
                </ul>
              </div>
            </div>
            <div class="single-blog-page">
              <div class="left-blog">
                <h4>archive</h4>
                <ul>
                  <li>
                    <a href="#">07 July 2016</a>
                  </li>
                  <li>
                    <a href="#">29 June 2016</a>
                  </li>
                  <li>
                    <a href="#">13 May 2016</a>
                  </li>
                  <li>
                    <a href="#">20 March 2016</a>
                  </li>
                  <li>
                    <a href="#">09 Fabruary 2016</a>
                  </li>
                </ul>
              </div>
            </div>
            <div class="single-blog-page">
              <div class="left-tags blog-tags">
                <div class="popular-tag left-side-tags left-blog">
                  <h4>popular tags</h4>
                  <ul>
                    <li>
                      <a href="#">Portfolio</a>
                    </li>
                    <li>
                      <a href="#">Project</a>
                    </li>
                    <li>
                      <a href="#">Design</a>
                    </li>
                    <li>
                      <a href="#">wordpress</a>
                    </li>
                    <li>
                      <a href="#">Joomla</a>
                    </li>
                    <li>
                      <a href="#">Html</a>
                    </li>
                    <li>
                      <a href="#">Masonry</a>
                    </li>
                    <li>
                      <a href="#">Website</a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- End left sidebar -->

            <!-- End Sidebar -->

            <!-- Main Content -->
            <div class="col-md-8 col-sm-8 col-xs-12">
                <div class="row">
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        <!-- Blog Post -->
                        <article class="blog-post-wrapper">
                            <div class="post-thumbnail">
                                {% if blog_post.image %}
                                    <img src="{{ blog_post.image.url }}" alt="Blog Image" />
                                {% else %}
                                    <img src="{% static 'img/blog/6.jpg' %}" alt="Default Image" />
                                {% endif %}
                            </div>
                            <div class="post-information">
                                <h2>{{ blog_post.title }}</h2>
                                <div class="entry-meta">
                                    <span class="author-meta">
                                        <i class="fa fa-user"></i> <a href="#">{{ blog_post.author.username }}</a>
                                    </span>
                                    <span>
                                        <i class="fa fa-clock-o"></i> {{ blog_post.created_at|date:"F j, Y" }}
                                    </span>
                                </div>
                                <div class="entry-content">
                                    {{ blog_post.content|safe }}
                                </div>
                            </div>
                        </article>

                        <!-- Comments Section -->
                        <div class="single-post-comments">
                            <div class="comments-area">
                                <div class="comments-heading">
                                  <h3 id="comment-count">{{ blog_post.comments.count }} Comments</h3>
                                </div>
                                <div class="comments-list">
                                  <ul id="comments-container">
                                      {% for comment in comments %}
                                      <li class="threaded-comments">
                                          <div class="comments-details">
                                              <div class="comments-list-img">
                                                  {% if comment.author.profile_picture %}
                                                      <img src="{{ comment.author.profile_picture.url }}" alt="Profile Picture" class="profile-img">
                                                  {% else %}
                                                      <img src="{% static 'img/default-profile.jpg' %}" alt="Default Profile Picture" class="profile-img">
                                                  {% endif %}
                                              </div>
                                              <div class="comments-content-wrap">
                                                  <span>
                                                      <b><a href="#">{{ comment.author.username }}</a></b>
                                                      <span class="post-time">
                                                          {{ comment.created_at|date:"F j, Y at g:i A" }}
                                                      </span>
                                                  </span>
                                                  <p>{{ comment.content }}</p>
                                                  <div class="comment-actions">
                                                      <span class="thumbs-up" data-comment-id="{{ comment.id }}" data-current-vote="{{ comment.user_vote }}">
                                                          <i class="fas fa-thumbs-up"></i> 
                                                          <span class="thumbs-up-count">{{ comment.thumbs_up_count }}</span>
                                                      </span>
                                                      <span class="thumbs-down" data-comment-id="{{ comment.id }}" data-current-vote="{{ comment.user_vote }}">
                                                          <i class="fas fa-thumbs-down"></i> 
                                                          <span class="thumbs-down-count">{{ comment.thumbs_down_count }}</span>
                                                      </span>
                                                      <span class="reply-action">
                                                          <i class="fas fa-reply"></i> Reply
                                                      </span>
                                                  </div>
                                              </div>
                                          </div>
                                      </li>
                                      {% endfor %}
                                  </ul>
                              </div>
                            </div>

                            <!-- Comment Form -->
                            <div class="comment-respond">
                                <h3 class="comment-reply-title">Leave a Reply</h3>
                                <form id="comment-form" method="post" action="{% url 'IDGenie:blog_detail' blog_post.id %}">
                                    {% csrf_token %}
                                    <div class="row">
                                        <div class="col-lg-12 col-md-12 col-sm-12 comment-form-comment">
                                            <textarea id="message-box" cols="30" rows="10" name="content" required></textarea>
                                            <input type="submit" value="Post Comment" />
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <!-- End Comments Section -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
  window.onload = function() {
    var iframes = document.querySelectorAll('iframe');
    iframes.forEach(function(iframe) {
        if (iframe.src.includes("youtube.com/embed")) {
            var wrapper = document.createElement('div');
            wrapper.classList.add('responsive-iframe-wrapper');
            iframe.parentNode.insertBefore(wrapper, iframe);
            wrapper.appendChild(iframe);
        }
    });

    var images = document.querySelectorAll('.entry-content img');
    images.forEach(function(img) {
        img.classList.add('responsive-img-wrapper');
    });
};


document.addEventListener('DOMContentLoaded', function () {
  const commentForm = document.querySelector('#comment-form');
  const commentInput = document.querySelector('#message-box');
  const commentsContainer = document.querySelector('#comments-container');
  const commentCountElement = document.querySelector('#comment-count');
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // Handle posting a new comment
  if (commentForm) {
      commentForm.addEventListener('submit', async function (event) {
          event.preventDefault();

          const content = commentInput.value.trim();

          if (!content) {
              alert('Comment cannot be empty.');
              return;
          }

          try {
              const response = await fetch('/post-comment/', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': csrfToken,
                  },
                  body: JSON.stringify({ content }),
              });

              if (!response.ok) {
                  throw new Error('Failed to post the comment.');
              }

              const data = await response.json();

              // Add the new comment to the DOM
              const newComment = document.createElement('li');
              newComment.classList.add('threaded-comments');
              newComment.innerHTML = `
                  <div class="comments-details">
                      <div class="comments-list-img">
                          <img src="${data.profile_picture_url || '/static/img/default-profile.jpg'}" alt="Profile Picture" class="profile-img">
                      </div>
                      <div class="comments-content-wrap">
                          <span>
                              <b><a href="#">${data.author}</a></b>
                              <span class="post-time">${data.created_at}</span>
                          </span>
                          <p>${data.content}</p>
                          <div class="comment-actions">
                              <span id="thumbs-up-count-${data.comment_id}" class="thumbs-up" data-comment-id="${data.comment_id}">
                                  <i class="fas fa-thumbs-up"></i> <span>0</span>
                              </span>
                              <span id="thumbs-down-count-${data.comment_id}" class="thumbs-down" data-comment-id="${data.comment_id}">
                                  <i class="fas fa-thumbs-down"></i> <span>0</span>
                              </span>
                          </div>
                      </div>
                  </div>
              `;
              commentsContainer.prepend(newComment);

              // Update the comment count
              const currentCount = parseInt(commentCountElement.textContent, 10) || 0;
              commentCountElement.textContent = `${currentCount + 1} Comments`;

              // Clear the input field
              commentInput.value = '';
          } catch (error) {
              console.error('Error posting comment:', error);
              alert('An error occurred while posting the comment.');
          }
      });
  }

  // Handle likes and dislikes
  if (commentsContainer) {
      commentsContainer.addEventListener('click', async function (event) {
          const thumb = event.target.closest('.thumbs-up') || event.target.closest('.thumbs-down');

          if (thumb) {
              const commentId = thumb.getAttribute('data-comment-id');
              const action = thumb.classList.contains('thumbs-up') ? 'like' : 'dislike';

              try {
                  const response = await fetch('/update-thumbs/', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                          'X-CSRFToken': csrfToken,
                      },
                      body: JSON.stringify({ comment_id: commentId, action }),
                  });

                  if (!response.ok) {
                      throw new Error('Failed to update the thumbs.');
                  }

                  const data = await response.json();

                  // Update the thumbs count
                  if (action === 'like') {
                      document.querySelector(`#thumbs-up-count-${commentId} span`).textContent = data.thumbs_up_count;
                  } else {
                      document.querySelector(`#thumbs-down-count-${commentId} span`).textContent = data.thumbs_down_count;
                  }
              } catch (error) {
                  console.error('Error updating thumbs:', error);
                  alert('An error occurred while updating the thumbs.');
              }
          }
      });
  }
});

</script>

{% endblock %}
